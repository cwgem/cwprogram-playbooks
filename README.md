# cwprogram.com Ansible Playbook Repository

This repository holds Ansible playbooks and roles for my personal site. A few things to note:

* `ansible.cfg` and the inventory file are not part of this repo so you will need to set those up yourself
* There is some manual bootstrap that still happens to setup the server for Ansible runs. This may be changed later if more servers are added
* Package wise this expects a fairly recent Gentoo linux system
* The iptables routes assume `eth0` interface so if you have udev static device nodes there will be a problem. This might be changed later with Ansible facts
* The system is Gentoo stable with a few caveats:
  * Python 3.5 is enabled by default
  * gunicorn is installed via an external repo that enables python 3.5 support and marks the package as stable

`ansible-playbook site.yml` 

Will run all the tasks. The actual site.yml is fairly minimal and simply declares the roles for the django servers. After all role related tasks iptables is reloaded to pull in any changes to files in `/etc/iptables.d`

## Roles
  
The site playbook utilizes the following roles
  
### iptables-common

This is a set of basic iptables rules that allow for SSH and DNS based traffic. ESTABLISHED and RELATED connections are accepted, as well as NEW SSH/DNS traffic. All localhost traffic is accepted. Everything else outside of that is dropped. DNS related rules loop through the Ansible facts for nameservers.
  
Loading of iptables is done through a bash script. To separate out the core iptables rules and rules generated by specific components (for example nginx opening up HTTP ports) an `/etc/iptables.d` directory is utilized. All `.sh` files in that directory are loaded after base rules. 
  
### portage-common
  
These are base rules for the portage package manager. This includes:
  
* Making sure various site overrides are available 
* Adding iptables rules for HTTP/HTTPS/FTP/RSYNC so emerge syncs and downloads work properly
* Adding a base make.conf
* Installing basic system packages 
* Running `emerge --sync` and doing a world update if it's been one week since last sync
  
### python35
  
This sets up python 3.5 support fot the system. Most of the work here is unmasking of keywords and targets. To set various python targets `/etc/portage/profile/make.defaults` is used. Since nginx also needs to interact with this file so the [blockinfile](https://docs.ansible.com/ansible/blockinfile_module.html) module is utilized. This allows for changes to be tracked so tasks are not run needlessly, and prevent nginx changes from being clobbered.

### django-appserver

This sets up django for doing application serving. In particular gunicorn is installed to act as the midway for nginx. Given that official Gentoo tree support is not available, gunicorn is installed from a github repo that adds python 3.5 support and marks the package as stable. 

### nginx

This role adds `/etc/portage/profile/make.defaults` entries for nginx modules. iptables rules are also added to accept port 80 and 443 traffic. There are plans for adding handlers to interact with the nginx service at some point.
